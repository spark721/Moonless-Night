<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">


  <link rel="icon" href="/client/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" type="text/css" href="/client/stylesheets/index.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="/client/stylesheets/index.css">
  <script src="/socket.io/socket.io.js"></script>

  <script src="/client/images/fire/fire_high.js"></script>
  <script src="/client/images/fire/medium_fire.js"></script>
  <script src="/client/images/fire/fire_very_low.js"></script>
  <script src="/client/images/fire/fire_critical.js"></script>

  <script src="/client/images/stalker/stalker_sprite.js"></script>
  <script src="/client/images/specter/specter_sprite.js"></script>
  <script src="/client/images/player/XX/walking/player_walk_right.js"></script>
  <script src="/client/images/player/XX/walking/player_walk_left.js"></script>
  <script src="/client/images/player/XX/walking/player_walk_up.js"></script>
  <script src="/client/images/player/XX/walking/player_walk_down.js"></script>
  <script src="/client/images/player/XX/idle/player_idle.js"></script>
  <script src="/client/images/player/XX/fetal/player_fetal.js"></script>
  <script src="/client/images/fire/torch.js"></script>

  <title>Moonless Night</title>
</head>
<body>
  <div class="canvas-chat">
    <canvas id='ctx'></canvas>
    <canvas id='fog'></canvas>
    <canvas id='dark'></canvas>
    <div class="chat">
      <div id="chat-text">
        <div>Keep the fire going!</div>
      </div>
      
      <form id="chat-form">
        <input type="text" 
              id="chat-input"
              placeholder="type your message here" >
      </form>
    </div>
  </div>
  
  
  <script>
        // - = - = - = - = - = fog of war START = - = - = - = - = -
          // create variables for fog of war
          let darkness = 0.85;
          let fogness = 0.8;
          let dark_color = "black";
          let fog_color = "black";
          let global_vision = [];
          let map_width = 1400;
          let map_height = 788;

          // entity variables for fog of war
          let entity_size = 20;
          let entities = [];
          let entity_color = "yellow";
          let entity_spacing = 100;
          let entity_vision_radius = 150;

          for (let i = 0; i < map_width / (entity_size + entity_spacing); i += 1) {
            for (let j = 0; j < map_height / (entity_size + entity_spacing); j += 1) {
              entities.push({
                x: i * (entity_size + entity_spacing) + entity_spacing / 2 - entity_size / 2,
                y: j * (entity_size + entity_spacing) + entity_spacing / 2 - entity_size / 2,
              });
            };
          };

          // get canvases
            let canvases = {
              main: document.getElementById("ctx"),
              fog: document.getElementById("fog"),
              dark: document.getElementById("dark"),
            }
          
          // set size
            canvases.main.width = canvases.fog.width = canvases.dark.width = map_width;
            canvases.main.height = canvases.fog.height = canvases.dark.height = map_height;
          // get contexts
            let main = canvases.main.getContext("2d");
            let fog = canvases.fog.getContext("2d");
            let dark = canvases.dark.getContext("2d");
          
          // get background image
            // let image = new Image();
            // image.src = "/client/images/background/bk_forest_night.png";
              
            function draw(e) {
              let pos = { x: e.clientX, y: e.clientY };
              let x = pos.x;
              let y = pos.y;

              let default_gco = main.globalCompositeOperation; // source-over

              // draw things
              // main.clearRect(0, 0, map_width, map_height);
              fog.clearRect(0, 0, map_width, map_height);
              dark.clearRect(0, 0, map_width, map_height);

              // Main
              // *** NOTE *** instead of here, bg was added it in css
              // main.drawImage(image, 0, 0, map_width, map_height);
              // main.fillStyle = entity_color;
              // for (let i = 0; i < entities.length; i += 1) {
              //   // add if statement
              //   let entity = entities[i];
              //   if (getDistance(entity, pos) < entity_vision_radius)
              //     main.fillRect(entity.x, entity.y, entity_size, entity_size);
              // }

              // draw fog
              fog.globalAlpha = fogness;
              fog.fillStyle = fog_color;
              fog.fillRect(0, 0, map_width, map_height);
              fog.globalCompositeOperation = 'destination-out';
              let fog_gd = fog.createRadialGradient(x, y, entity_vision_radius, x, y, entity_vision_radius / 1.2);
              fog_gd.addColorStop(0, 'rgba(0,0,0,0)');
              fog_gd.addColorStop(1, 'rgba(0,0,0,1)');
              fog.fillStyle = fog_gd;
              fog.beginPath();
              fog.arc(x, y, entity_vision_radius, 0, 2 * Math.PI);
              fog.closePath();
              fog.fill();

              // draw darkness
              dark.globalAlpha = darkness;
              dark.fillStyle = dark_color;
              dark.fillRect(0, 0, map_width, map_height);
              dark.globalCompositeOperation = 'destination-out';

              let push = true;
              if (global_vision.length === 0)
                global_vision.push(pos);
              for (let i = 0; i < global_vision.length; i += 1) {
                let gv = global_vision[i];
                let dark_gd = dark.createRadialGradient(gv.x, gv.y, entity_vision_radius, gv.x, gv.y, entity_vision_radius / 1.2);
                dark_gd.addColorStop(0, 'rgba(0,0,0,0)');
                dark_gd.addColorStop(1, 'rgba(0,0,0,1)');
                dark.fillStyle = dark_gd;
                dark.beginPath();
                dark.arc(gv.x, gv.y, entity_vision_radius, 0, 2 * Math.PI);
                dark.closePath();
                dark.fill();

                if (getDistance(pos, gv) < entity_vision_radius) push = false;
              }

              if (push) global_vision.push(pos);

              fog.globalCompositeOperation = dark.globalCompositeOperation = default_gco;
            }


            function getDistance(pos1, pos2) {
              let dx = pos1.x - pos2.x;
              let dy = pos1.y - pos2.y;
              return Math.sqrt(dx * dx + dy * dy);
            }

            
            canvases.dark.addEventListener("mousemove", draw);

              


        // - = - = - = - = - = fog of war END = - = - = - = - = -
    
    const chatText = document.getElementById("chat-text")
    const chatInput = document.getElementById("chat-input")
    const chatForm = document.getElementById("chat-form")
    const logImage = new Image();
    logImage.src = '/client/images/logs/spr_log_0.png'
    const torchImage = new Image();
    torchImage.src = '/client/images/fire/fire_medium_sprites.png'

    const ctx = document.getElementById('ctx').getContext('2d');
    ctx.font = '20px Arial';

    ctx.fillStyle = "#FFFFFF";

    const socket = io();

    socket.on('pack', data => {
      // clear canvas
      ctx.clearRect(0, 0, 1400, 788);
      for (let i = 0; i < data.player.length; i++) {
        // ctx.fillText(data.player[i].state, 100, 100)
        // ctx.beginPath();
        // ctx.arc(data.player[i].x, data.player[i].y, data.player[i].size, 0, 2 * Math.PI);
        // ctx.stroke();

        if (data.player[i].pressingRight && data.player[i].state !== "FETAL" ) drawWalkRight(data.player[i].x - 17, data.player[i].y - 55)
        if (data.player[i].pressingLeft && data.player[i].state !== "FETAL") drawWalkLeft(data.player[i].x - 17, data.player[i].y - 55)
        if (data.player[i].pressingUp && data.player[i].state !== "FETAL") drawWalkUp(data.player[i].x - 17, data.player[i].y - 55)
        if (data.player[i].pressingDown && data.player[i].state !== "FETAL") drawWalkDown(data.player[i].x - 17, data.player[i].y - 55)
        if (data.player[i].state === "FETAL") drawFetal(data.player[i].x - 17, data.player[i].y - 55)

        if (
          !data.player[i].pressingDown &&
          !data.player[i].pressingUp &&
          !data.player[i].pressingLeft &&
          !data.player[i].pressingRight &&
          data.player[i].state !== "FETAL") {
          drawPlayerIdle(data.player[i].x - 17, data.player[i].y - 55)
        }

        // TORCH RENDERING

        if (data.player[i].state === "TORCH") lowFireDraw(data.player[i].x - 80, data.player[i].y - 110)

        if (data.player[i].state === "LOGS") ctx.drawImage(logImage, 0, 0, 50, 50, data.player[i].x - 10, data.player[i].y - 25, 64, 40)
      }
      // TEST

      




      // END TEST
      ctx.fillText(`${data.fire.firePower}`, 685, 460);
      

      // render trees
      for (let i = 0; i < data.tree.length; i++) {
        let tree = data.tree[i];

        if (tree.logs > 0) {
          const treeImage = new Image();
          treeImage.src = `/client/images/trees/${(tree.id % 4) + 1}${tree.logs}.png`;
          ctx.drawImage(treeImage, tree.x - 50 * (tree.logs / 6 + 0.5), tree.y - 175 * (tree.logs / 6 + 0.5), 100 * (tree.logs / 6 + 0.5), 200 * (tree.logs / 6 + 0.5));
        }
      }

      //specter
      for (let i = 0; i < data.specter.length; i++) {
        ctx.fillStyle = "#3370d4";
        ctx.beginPath();
        // ctx.arc(data.specter[i].x, data.specter[i].y, data.specter[i].size, 0, 2 * Math.PI);
        specterDrawImage(data.specter[i].x - 15, data.specter[i].y - 15);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();  
      

      }    
      //stalker
      for (let i = 0; i < data.stalker.length; i++) {
        ctx.fillStyle = "#c82124";
        ctx.beginPath();
        // ctx.arc(data.stalker[i].x, data.stalker[i].y, data.stalker[i].size, 0, 2 * Math.PI);
        stalkerDrawImage(data.stalker[i].x-27, data.stalker[i].y-35);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();  
      }    
      //log
      for (let i = 0; i < data.log.length; i++) {
        // ctx.fillStyle = "brown";
        // ctx.beginPath();
        // ctx.arc(data.log[i].x, data.log[i].y, data.log[i].size, 0, 2 * Math.PI);
        // ctx.closePath();
        // ctx.fill();
        // ctx.stroke();  
        ctx.drawImage(logImage, 0, 0, 50, 50, data.log[i].x - 20, data.log[i].y - 10, 64, 40)
        
    }    
    //torch
    for (let i = 0; i < data.torch.length; i++) {
      // ctx.fillStyle = "orange";
      // ctx.beginPath();
      // ctx.arc(data.torch[i].x, data.torch[i].y, data.torch[i].size, 0, 2 * Math.PI);
      // ctx.closePath();
      // ctx.fill();
      // ctx.stroke();  
      // ctx.drawImage(torchImage, 0, 0, 102, 205, data.torch[i].x - 20, data.torch[i].y - 10, 64, 40)
      lowFireDraw(data.torch[i].x-60, data.torch[i].y-120)
    }    
    // ctx.fillStyle = "rgba(255, 255, 255, 0)";
    console.log(data.fire.status)
    if (data.fire.status === "HIGH") {
      highFireDrawImage();
    }else if (data.fire.status === "MEDIUM"){
      medFireDrawImage();
    }else if (data.fire.status === "VERY LOW"){
      veryLowFireDrawImage();
    }else if (data.fire.status === "CRITICAL"){
      criticalFireDrawImage();
    }else{
      medFireDrawImage();
    }
    ctx.fillStyle = "#FFFFFF";

      
      
    })

    socket.on("addToChat", (data) => {
      chatText.innerHTML += '<div>' + data + '</div>';
    });

    chatForm.onsubmit = (e) => {
      e.preventDefault();
      socket.emit("sendMsgToServer", chatInput.value);
      chatInput.value = "";
    };


    document.onkeydown = event => {
      if (event.keyCode === 68) socket.emit('keyPress', { inputId: 'right', state: true }); // d
      if (event.keyCode === 65) socket.emit('keyPress', { inputId: 'left', state: true }); // a
      if (event.keyCode === 87) socket.emit('keyPress', { inputId: 'up', state: true }); // w
      if (event.keyCode === 83) socket.emit('keyPress', { inputId: 'down', state: true }); // s
      if (event.keyCode === 69) socket.emit('keyPress', { inputId: 'chop', state: true }); // j
      if (event.keyCode === 81) socket.emit('keyPress', { inputId: 'drop', state: true }); // k
      if (event.keyCode === 82) socket.emit('keyPress', { inputId: 'heal', state: true }); // h
    }

    document.onkeyup = event => {
      if (event.keyCode === 68) socket.emit('keyPress', { inputId: 'right', state: false });
      if (event.keyCode === 65) socket.emit('keyPress', { inputId: 'left', state: false });
      if (event.keyCode === 87) socket.emit('keyPress', { inputId: 'up', state: false });
      if (event.keyCode === 83) socket.emit('keyPress', { inputId: 'down', state: false });
      if (event.keyCode === 69) socket.emit('keyPress', { inputId: 'chop', state: false });
      if (event.keyCode === 81) socket.emit('keyPress', { inputId: 'drop', state: false });
      if (event.keyCode === 82) socket.emit('keyPress', { inputId: 'heal', state: false });
    }

    socket.on("over", () => {
      document.getElementById('game-over').style.display = "block";
    })

    socket.on("win", () => {
      document.getElementById('winner').style.display = "block";
    })

    const off = () => {
      document.getElementById('game-over').style.display = "none";
    }
    const offwin = () => {
      document.getElementById('winner').style.display = "none";
    }
  </script>

  <div id="game-over" onclick="off()" >
    <a href="/"><span class="game-over-msg">YOU LOST</span></a>
  </div>

  <div id="winner" onclick="offwin()" >
    <a href="/"><span class="winner-msg">YOU WIN</span></a>
  </div>

    <article class="instructions-container">
      <div class="specter">
        <img src="/client/images/instructions/specter.png" alt="">
        <p>SPECTER</p>
      </div>
      <div class="instruction">
        <h3>Goal: keep the fire alive until sunrise (90 seconds). Evade ghosts.</h3>
        <h3><span class="bolded-instructions">Specters</span> can be stopped with <span
            class="bolded-instructions">torches.</span> <span class="bolded-instructions">Stalkers</span> are <span
            class="bolded-white">immortal</span></h3>
        <p class="bolded-instructions">MOVE THE MOUSE TO CLEAR THE FOG OF WAR</p>
        <p><span class="bolded-instructions">W, A, S, D</span>: directional movement</p>
        <p><span class="bolded-instructions">E: PICK UP</span> items (trees, logs, or torches)</p>
        <p><span class="bolded-instructions">Q: DROP</span> held items</p>
        <p><span class="bolded-instructions">R: REVIVE</span> fallen teammates</p>
      </div>
      <div class="stalker">
        <img src="/client/images/instructions/stalker.png" alt="">
        <p>STALKER</p>
      </div>
    </article>
  
</body>
</html>
